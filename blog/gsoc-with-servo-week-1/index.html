<!doctype html> <html lang=en> <head> <meta charset=utf-8> <meta content="width=device-width,initial-scale=1" name=viewport> <base href=/ > <link href=global.css rel=stylesheet> <link href=favicon.png rel=icon type=image/png> <noscript id=sapper-head-start></noscript><title>GSoC with Servo - week 1</title><noscript id=sapper-head-end></noscript> </head> <body> <div id=sapper> <main> <div class=siimple-content--medium><div class="siimple--mx-4 siimple--my-4"><div class=siimple-h3>GSoC with Servo - week 1</div> <div> <p>For Google Summer of Code 2019, I'm working on improving WebDriver support in Servo. The details of the project can be found <a href=https://summerofcode.withgoogle.com/dashboard/project/5248302524661760/details/ >here</a>.</p> <p>In the first week of the coding period I managed to fix both of the issues related to creating new WebDriver sessions during testing.</p> <p>The current WebDriver implementation doesn't support multiple concurrent sessions. Trying to create a new session while another one is still active results in a <code>Session is already started</code> error. This is exactly the <a href=https://github.com/servo/servo/issues/22619>error</a> we were intermittently getting when running the automated WebBluetooth tests and the error we were always getting when running the <code>wdspec</code> <a href=https://github.com/servo/servo/tree/master/tests/wpt/web-platform-tests/webdriver/tests/new_session><code>new_session</code></a> tests. Note that both of these tests are parallelized.</p> <p>While investigating what might possibly cause the error in the WebBluetooth tests, I noticed that whenever it occured, the <a href=https://github.com/servo/servo/tree/master/tests/wpt/web-platform-tests/tools/wptrunner/wptrunner>wptrunner</a> test runner strangely assigned the same port to different instances of WebDriver. Having several processes trying to create a new session on the same port was the cause of the error. It seemed that there was a data race when assigning ports for the WebDriver instances. I solved this by <a href=https://github.com/web-platform-tests/wpt/pull/16819>protecting</a> the retrieval of a free port with a lock.</p> <p>But it seemed that this was not enough. The <code>new_session</code> tests were still failing due to the same error. As I fully described <a href=https://github.com/servo/servo/issues/22619#issuecomment-496270969>here</a>, this was happening because for the <code>wdspec</code> tests, the port retrieval was not done in different threads, as for the WebBluetooth tests, but in different processes. Each process had a different copy of the state needed to safely retrieve a free port and the changes made by one process to it were not reflected in the other processes. This time, the <a href=https://github.com/web-platform-tests/wpt/pull/17047>solution</a> was to switch to random OS port retrieval by always binding to port <code>0</code>. Although this is still prone to data races, it was the easiest solution, as sharing state between different processes is not trivial to do.</p> <p>Once I got these issues fixed, I focused on implementing the <a href=https://w3c.github.io/webdriver/#new-session-0>w3c specification</a> for the <code>New Session</code> command. As a result of this, the majority of the associated <code>wdspec</code> tests are now passing.</p> <p>I also started to check the status of the whole <code>wdspec</code> test suite. Unsurprisingly, there are lots of errors and failures. However, I found a common error in the majority of the tests and that's what I'm going to focus on next.</p> <p>It was a great first week! I learned a lot about concurrency and realized how hard it is to write programs that are both safe and concurrent.</p> </div></div></div></main></div> <script>__SAPPER__={baseUrl:"",preloaded:[void 0,null,{post:{title:"GSoC with Servo - week 1",date:"2019-06-04T00:00:00.000Z",slug:"gsoc-with-servo-week-1",html:"\n\u003Cp\u003EFor Google Summer of Code 2019, I'm working on improving WebDriver support in Servo.\nThe details of the project can be found \u003Ca href=\"https:\u002F\u002Fsummerofcode.withgoogle.com\u002Fdashboard\u002Fproject\u002F5248302524661760\u002Fdetails\u002F\"\u003Ehere\u003C\u002Fa\u003E.\u003C\u002Fp\u003E\n\u003Cp\u003EIn the first week of the coding period I managed to fix both of the issues related to creating new WebDriver sessions during testing.\u003C\u002Fp\u003E\n\u003Cp\u003EThe current WebDriver implementation doesn't support multiple concurrent sessions.\nTrying to create a new session while another one is still active results in a \u003Ccode\u003ESession is already started\u003C\u002Fcode\u003E error.\nThis is exactly the \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fservo\u002Fservo\u002Fissues\u002F22619\"\u003Eerror\u003C\u002Fa\u003E we were intermittently getting when running the automated WebBluetooth tests and the error we were always getting\nwhen running the \u003Ccode\u003Ewdspec\u003C\u002Fcode\u003E \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fservo\u002Fservo\u002Ftree\u002Fmaster\u002Ftests\u002Fwpt\u002Fweb-platform-tests\u002Fwebdriver\u002Ftests\u002Fnew_session\"\u003E\u003Ccode\u003Enew_session\u003C\u002Fcode\u003E\u003C\u002Fa\u003E tests.\nNote that both of these tests are parallelized.\u003C\u002Fp\u003E\n\u003Cp\u003EWhile investigating what might possibly cause the error in the WebBluetooth tests, I noticed that whenever it occured,\nthe \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fservo\u002Fservo\u002Ftree\u002Fmaster\u002Ftests\u002Fwpt\u002Fweb-platform-tests\u002Ftools\u002Fwptrunner\u002Fwptrunner\"\u003Ewptrunner\u003C\u002Fa\u003E test runner strangely assigned the same port to different instances of WebDriver.\nHaving several processes trying to create a new session on the same port was the cause of the error.\nIt seemed that there was a data race when assigning ports for the WebDriver instances.\nI solved this by \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fweb-platform-tests\u002Fwpt\u002Fpull\u002F16819\"\u003Eprotecting\u003C\u002Fa\u003E the retrieval of a free port with a lock.\u003C\u002Fp\u003E\n\u003Cp\u003EBut it seemed that this was not enough.\nThe \u003Ccode\u003Enew_session\u003C\u002Fcode\u003E tests were still failing due to the same error.\nAs I fully described \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fservo\u002Fservo\u002Fissues\u002F22619#issuecomment-496270969\"\u003Ehere\u003C\u002Fa\u003E, this was happening because for the \u003Ccode\u003Ewdspec\u003C\u002Fcode\u003E tests,\nthe port retrieval was not done in different threads, as for the WebBluetooth tests, but in different processes.\nEach process had a different copy of the state needed to safely retrieve a free port and the changes made by one process to it were not reflected in the other processes.\nThis time, the \u003Ca href=\"https:\u002F\u002Fgithub.com\u002Fweb-platform-tests\u002Fwpt\u002Fpull\u002F17047\"\u003Esolution\u003C\u002Fa\u003E was to switch to random OS port retrieval by always binding to port \u003Ccode\u003E0\u003C\u002Fcode\u003E.\nAlthough this is still prone to data races, it was the easiest solution, as sharing state between different processes is not trivial to do.\u003C\u002Fp\u003E\n\u003Cp\u003EOnce I got these issues fixed, I focused on implementing the \u003Ca href=\"https:\u002F\u002Fw3c.github.io\u002Fwebdriver\u002F#new-session-0\"\u003Ew3c specification\u003C\u002Fa\u003E for the \u003Ccode\u003ENew Session\u003C\u002Fcode\u003E command.\nAs a result of this, the majority of the associated \u003Ccode\u003Ewdspec\u003C\u002Fcode\u003E tests are now passing.\u003C\u002Fp\u003E\n\u003Cp\u003EI also started to check the status of the whole \u003Ccode\u003Ewdspec\u003C\u002Fcode\u003E test suite.\nUnsurprisingly, there are lots of errors and failures.\nHowever, I found a common error in the majority of the tests and that's what I'm going to focus on next.\u003C\u002Fp\u003E\n\u003Cp\u003EIt was a great first week! I learned a lot about concurrency and realized how hard it is to write programs that are both safe and concurrent.\u003C\u002Fp\u003E\n"}}]};if('serviceWorker' in navigator)navigator.serviceWorker.register('/service-worker.js');(function(){try{eval("async function x(){}");var main="/client/client.e5726ad4.js"}catch(e){main="/client/legacy/client.326a6068.js"};var s=document.createElement("script");try{new Function("if(0)import('')")();s.src=main;s.type="module";s.crossOrigin="use-credentials";}catch(e){s.src="/client/shimport@1.0.1.js";s.setAttribute("data-main",main);}document.head.appendChild(s);}());</script> 