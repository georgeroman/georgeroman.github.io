{"title":"GSoC with Servo - weeks 11 and 12","date":"2019-08-19T00:00:00.000Z","slug":"gsoc-with-servo-weeks-11-and-12","html":"\n<p>Weeks 11 and 12 have been quite productive, with a good amount of new features added to WebDriver.</p>\n<p>One new command that got <a href=\"https://github.com/servo/servo/pull/23943\">implemented</a> last week is <a href=\"https://w3c.github.io/webdriver/#take-element-screenshot\"><code>TakeElementScreenshot</code></a>.\nAlthough it's very similar to <a href=\"https://w3c.github.io/webdriver/#take-screenshot\"><code>TakeScreenshot</code></a> in terms of implementation, it needed some additional small tweaks in order to work properly.</p>\n<p>The core functionality of both of these commands is offered by <a href=\"https://github.com/servo/servo/blob/fb5a12159a2f7e84ac2470952078a4dafa3ce28e/components/compositing/gl.rs#L82\"><code>draw_img</code></a> which,\nas the name implies, encodes part (a rectangle) of the frame buffer into an image.\nBefore, <a href=\"https://github.com/servo/servo/blob/fb5a12159a2f7e84ac2470952078a4dafa3ce28e/components/compositing/gl.rs#L82\"><code>draw_img</code></a> expected that rectangle to always start at point <code>(0, 0)</code>.\nBut for <a href=\"https://w3c.github.io/webdriver/#take-element-screenshot\"><code>TakeElementScreenshot</code></a> the screenshotted rectangle could start anywhere in the viewport, not necessarily at that point.\nThis was easily addressed, but it was not all I needed.\nOne more thing that was needed was the conversion between an element's rectangle top left corner coordinates to its down left corner coordinates used by OpenGL.\nBasically, the <code>y</code> coordinate required conversion using a simple formula:</p>\n<p><code>down_left_y = viewport_height - top_left_y - rect_height</code></p>\n<p>Another new thing that I did last week was <a href=\"https://github.com/servo/servo/pull/23951\">change</a> the communication between the WebDriver server and the browser to have it possible\nto propagate error codes between the two.\nThis was an easy change, but it involved a lot of additional small changes.\nAt this step I also added proper distinction between <a href=\"https://w3c.github.io/webdriver/#dfn-is-stale\">stale</a> and inexistent elements.\nThis involved keeping track of all the nodes ever created in the current\n<a href=\"https://github.com/servo/servo/blob/fb5a12159a2f7e84ac2470952078a4dafa3ce28e/components/script/script_thread.rs#L521\"><code>ScriptThread</code></a> and then use this information in\n<a href=\"https://github.com/servo/servo/blob/fb5a12159a2f7e84ac2470952078a4dafa3ce28e/components/script/webdriver_handlers.rs#L57\"><code>find_node_by_unique_id</code></a>.</p>\n<p>The work on <a href=\"https://web-platform-tests.org/writing-tests/testdriver.html\">testdriver.js</a> got blocked by a <a href=\"https://github.com/servo/webrender/issues/3739\">strange panick</a>.\nAt a first glance, this has an easy fix but, since I'm not very familiar with <a href=\"https://github.com/servo/webrender\"><code>webrender</code></a>, I'm not sure if it's the right fix or not.\nFortunately, I've managed to patch my own version of <a href=\"https://github.com/servo/webrender\"><code>webrender</code></a> so I can continue working on\n<a href=\"https://web-platform-tests.org/writing-tests/testdriver.html\">testdriver.js</a> without getting into this failure again.</p>\n<p>There is only one more week left of GSoC, twelve weeks have passed so quickly! In the last week I'm planning to wrap up the awaiting pull requests\n(<a href=\"https://github.com/servo/servo/pull/23996\"><code>pointerMove</code></a> WebDriver action and <a href=\"https://github.com/servo/servo/pull/23947\">final additions</a> to the <code>JSON</code> clone algorithm)\nand continue working on the <a href=\"https://github.com/servo/servo/pull/23947\">testdriver.js</a>.</p>\n"}