<!doctype html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="x-ua-compatible" content="ie=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <title>georgeroman - GSoC with Servo - weeks 11 and 12</title>
        <link rel="stylesheet" href="../css/default.css" />
    </head>
    <body>
        <header>
            <div class="logo">
                <a href="../">George's blog</a>
            </div>
            <nav>
                <a href="../">Home</a>
                <a href="../about.html">About</a>
                <a href="../contact.html">Contact</a>
                <a href="../archive.html">Archive</a>
            </nav>
        </header>

        <main role="main">
            <h1>GSoC with Servo - weeks 11 and 12</h1>
            <article>
    <section class="header">
        Posted on August 19, 2019
        
            by George Roman
        
    </section>
    <section>
        <p>Weeks 11 and 12 have been quite productive, with a good amount of new features added to WebDriver.</p>
<p>One new command that got <a href="https://github.com/servo/servo/pull/23943">implemented</a> last week is <a href="https://w3c.github.io/webdriver/#take-element-screenshot"><code>TakeElementScreenshot</code></a>. Although it’s very similar to <a href="https://w3c.github.io/webdriver/#take-screenshot"><code>TakeScreenshot</code></a> in terms of implementation, it needed some additional small tweaks in order to work properly.</p>
<p>The core functionality of both of these commands is offered by <a href="https://github.com/servo/servo/blob/fb5a12159a2f7e84ac2470952078a4dafa3ce28e/components/compositing/gl.rs#L82"><code>draw_img</code></a> which, as the name implies, encodes part (a rectangle) of the frame buffer into an image. Before, <a href="https://github.com/servo/servo/blob/fb5a12159a2f7e84ac2470952078a4dafa3ce28e/components/compositing/gl.rs#L82"><code>draw_img</code></a> expected that rectangle to always start at point <code>(0, 0)</code>. But for <a href="https://w3c.github.io/webdriver/#take-element-screenshot"><code>TakeElementScreenshot</code></a> the screenshotted rectangle could start anywhere in the viewport, not necessarily at that point. This was easily addressed, but it was not all I needed. One more thing that was needed was the conversion between an element’s rectangle top left corner coordinates to its down left corner coordinates used by OpenGL. Basically, the <code>y</code> coordinate required conversion using a simple formula:</p>
<p><code>down_left_y = viewport_height - top_left_y - rect_height</code></p>
<p>Another new thing that I did last week was <a href="https://github.com/servo/servo/pull/23951">change</a> the communication between the WebDriver server and the browser to have it possible to propagate error codes between the two. This was an easy change, but it involved a lot of additional small changes. At this step I also added proper distinction between <a href="https://w3c.github.io/webdriver/#dfn-is-stale">stale</a> and inexistent elements. This involved keeping track of all the nodes ever created in the current <a href="https://github.com/servo/servo/blob/fb5a12159a2f7e84ac2470952078a4dafa3ce28e/components/script/script_thread.rs#L521"><code>ScriptThread</code></a> and then use this information in <a href="https://github.com/servo/servo/blob/fb5a12159a2f7e84ac2470952078a4dafa3ce28e/components/script/webdriver_handlers.rs#L57"><code>find_node_by_unique_id</code></a>.</p>
<p>The work on <a href="https://web-platform-tests.org/writing-tests/testdriver.html">testdriver.js</a> got blocked by a <a href="https://github.com/servo/webrender/issues/3739">strange panick</a>. At a first glance, this has an easy fix but, since I’m not very familiar with <a href="https://github.com/servo/webrender"><code>webrender</code></a>, I’m not sure if it’s the right fix or not. Fortunately, I’ve managed to patch my own version of <a href="https://github.com/servo/webrender"><code>webrender</code></a> so I can continue working on <a href="https://web-platform-tests.org/writing-tests/testdriver.html">testdriver.js</a> without getting into this failure again.</p>
<p>There is only one more week left of GSoC, twelve weeks have passed so quickly! In the last week I’m planning to wrap up the awaiting pull requests (<a href="https://github.com/servo/servo/pull/23996"><code>pointerMove</code></a> WebDriver action and <a href="https://github.com/servo/servo/pull/23947">final additions</a> to the <code>JSON</code> clone algorithm) and continue working on the <a href="https://github.com/servo/servo/pull/23947">testdriver.js</a>.</p>
    </section>
</article>

        </main>

        <footer>
            Site proudly generated by
            <a href="http://jaspervdj.be/hakyll">Hakyll</a>
        </footer>
    </body>
</html>
